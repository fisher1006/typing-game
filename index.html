<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„¿ç«¥æ‰“å­—å­¦ä¹ æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            touch-action: manipulation;
            overflow-x: hidden;
        }

        body {
            font-family: 'Comic Sans MS', 'Microsoft YaHei', cursive, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #E0F7FA 50%, #98FB98 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .title {
            font-size: clamp(24px, 6vw, 36px);
            color: #FF6B6B;
            text-shadow: 2px 2px 0 #FFE66D, 4px 4px 0 rgba(0,0,0,0.1);
            margin-bottom: 8px;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            font-size: clamp(16px, 4vw, 20px);
        }

        .stat {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .star { color: #FFD700; }
        .combo { color: #FF6B6B; }

        /* Stage Selector */
        .stage-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stage-btn {
            padding: 10px 16px;
            font-size: clamp(14px, 3.5vw, 18px);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .stage-btn:nth-child(1) { background: #4ECDC4; color: white; }
        .stage-btn:nth-child(2) { background: #45B7D1; color: white; }
        .stage-btn:nth-child(3) { background: #96CEB4; color: white; }

        .stage-btn.active {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* Difficulty */
        .difficulty {
            margin-bottom: 15px;
        }

        .difficulty select {
            padding: 8px 16px;
            font-size: clamp(14px, 3.5vw, 16px);
            border-radius: 15px;
            border: 2px solid #4ECDC4;
            font-family: inherit;
        }

        /* Game Area */
        .game-area {
            background: white;
            border-radius: 25px;
            padding: clamp(20px, 5vw, 40px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
            width: 100%;
            max-width: 500px;
            min-height: 180px;
            margin-bottom: 20px;
        }

        .current-char {
            font-size: clamp(60px, 20vw, 120px);
            color: #333;
            margin: 15px 0;
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .pinyin-label {
            font-size: clamp(20px, 5vw, 28px);
            color: #666;
            margin-bottom: 10px;
        }

        .hint {
            font-size: clamp(14px, 3.5vw, 18px);
            color: #999;
        }

        /* Virtual Keyboard */
        .keyboard {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: #2C3E50;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 600px;
            /* é»˜è®¤éšè—ï¼Œç§»åŠ¨ç«¯æ¸¸æˆæ—¶æ˜¾ç¤º */
        }

        .keyboard.hidden {
            display: none;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .key {
            width: clamp(28px, 8vw, 50px);
            height: clamp(28px, 8vw, 50px);
            background: #34495E;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(12px, 3vw, 22px);
            color: white;
            transition: all 0.15s;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .key:active {
            transform: scale(0.95);
        }

        .key.highlight {
            background: #F39C12 !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px #F39C12;
        }

        .key.pressed {
            transform: scale(0.95);
            background: #27AE60 !important;
        }

        /* On-screen keyboard for mobile */
        .mobile-keyboard {
            display: none;
            width: 100%;
            max-width: 500px;
            background: #2C3E50;
            padding: 8px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .mobile-keyboard.active {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mobile-keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .mobile-key {
            flex: 1;
            min-width: 25px;
            max-width: 45px;
            height: clamp(35px, 10vw, 50px);
            background: #34495E;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(10px, 3vw, 18px);
            color: white;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .mobile-key:active, .mobile-key.highlight {
            background: #4ECDC4;
            transform: scale(0.95);
        }

        /* Timer */
        .timer {
            width: 100%;
            max-width: 200px;
            height: 8px;
            background: #EEE;
            border-radius: 4px;
            margin: 0 auto 15px;
            overflow: hidden;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #45B7D1);
            transition: width 0.1s linear;
            width: 100%;
        }

        /* Star Animation */
        .star-popup {
            position: fixed;
            font-size: clamp(40px, 10vw, 60px);
            animation: starFly 1s forwards;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes starFly {
            0% { opacity: 1; transform: scale(0) translateY(0); }
            50% { opacity: 1; transform: scale(1.2) translateY(-50px); }
            100% { opacity: 0; transform: scale(1) translateY(-100px); }
        }

        /* Character Options (Stage 3) */
        .char-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .char-option {
            width: clamp(50px, 15vw, 80px);
            height: clamp(50px, 15vw, 80px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(24px, 6vw, 40px);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: inherit;
        }

        .char-option:active {
            transform: scale(0.95);
        }

        .char-option.correct {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
        }

        .char-option.wrong {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%);
        }

        /* Start Screen */
        .start-screen {
            text-align: center;
        }

        .start-btn {
            font-size: clamp(20px, 5vw, 28px);
            padding: 15px 40px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 5px 20px rgba(255,107,107,0.4);
            transition: all 0.3s;
        }

        .start-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,107,107,0.5);
        }

        /* Caps Lock Warning */
        .caps-warning {
            background: #FFE66D;
            color: #333;
            padding: 8px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: clamp(12px, 3vw, 16px);
            display: none;
        }

        /* Restart Button */
        .restart-btn {
            font-size: clamp(14px, 3.5vw, 18px);
            padding: 8px 20px;
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 15px;
            font-family: inherit;
        }

        /* Mobile hint */
        .mobile-hint {
            display: none;
            font-size: clamp(12px, 3vw, 14px);
            color: #666;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .mobile-hint {
                display: block;
            }
            .keyboard {
                display: none;
            }
            .mobile-keyboard {
                display: none;
            }
            .mobile-keyboard.active {
                display: flex;
            }
        }

        /* Desktop - show virtual keyboard */
        @media (min-width: 769px) {
            .keyboard {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ¯ å„¿ç«¥æ‰“å­—å­¦ä¹ æ¸¸æˆ</h1>
        <div class="stats">
            <div class="stat">â­ <span id="stars">0</span></div>
            <div class="stat">ğŸ”¥ Combo: <span id="combo">0</span></div>
        </div>
    </div>

    <div class="caps-warning" id="capsWarning">
        âš ï¸ è¯·å…³é—­ Caps Lock å¤§å†™é”å®šé”®
    </div>

    <div class="stage-selector">
        <button class="stage-btn active" data-stage="1">ğŸ”¤ å­—æ¯</button>
        <button class="stage-btn" data-stage="2">ğŸ“ æ‹¼éŸ³</button>
        <button class="stage-btn" data-stage="3">ğŸˆ¶ é€‰å­—</button>
    </div>

    <div class="difficulty">
        <select id="difficulty">
            <option value="easy">ğŸŒŸ ç®€å•</option>
            <option value="medium">âš¡ ä¸­ç­‰</option>
            <option value="hard">ğŸ”¥ å›°éš¾</option>
        </select>
    </div>

    <div class="mobile-hint" id="mobileHint">
        ğŸ“± æ‰‹æœºç«¯ç‚¹å‡»ä¸‹æ–¹é”®ç›˜è¾“å…¥
    </div>

    <div class="game-area" id="gameArea">
        <div class="start-screen">
            <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ ğŸ®</button>
        </div>
    </div>

    <!-- æ¡Œé¢ç«¯è™šæ‹Ÿé”®ç›˜ -->
    <div class="keyboard" id="keyboard"></div>

    <!-- ç§»åŠ¨ç«¯é”®ç›˜ -->
    <div class="mobile-keyboard" id="mobileKeyboard"></div>

    <div class="timer" id="timerContainer" style="display: none;">
        <div class="timer-bar" id="timerBar"></div>
    </div>

    <script>
        // Game State
        let state = {
            stage: 1,
            difficulty: 'easy',
            stars: 0,
            combo: 0,
            currentTarget: '',
            currentInput: '',
            isPlaying: false,
            timer: null,
            timeLeft: 10,
            maxTime: 10,
            isMobile: false
        };

        // Data
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
        
        const pinyinData = [
            { han: 'é©¬', pinyin: 'ma' },
            { han: 'çŒ«', pinyin: 'mao' },
            { han: 'ç‹—', pinyin: 'gou' },
            { han: 'é±¼', pinyin: 'yu' },
            { han: 'é¸Ÿ', pinyin: 'niao' },
            { han: 'å…”', pinyin: 'tu' },
            { han: 'çŒª', pinyin: 'zhu' },
            { han: 'ç¾Š', pinyin: 'yang' },
            { han: 'ç‰›', pinyin: 'niu' },
            { han: 'è‹¹æœ', pinyin: 'pingguo' },
            { han: 'çˆ¸çˆ¸', pinyin: 'baba' },
            { han: 'å¦ˆå¦ˆ', pinyin: 'mama' },
            { han: 'çˆ·çˆ·', pinyin: 'yeye' },
            { han: 'å¥¶å¥¶', pinyin: 'naiai' },
            { han: 'å“¥å“¥', pinyin: 'gege' },
            { han: 'å¼Ÿå¼Ÿ', pinyin: 'didi' },
            { han: 'å§å§', pinyin: 'jiejie' },
            { han: 'å¦¹å¦¹', pinyin: 'meimei' },
            { han: 'æœ‹å‹', pinyin: 'pengyou' },
            { han: 'è€å¸ˆ', pinyin: 'laoshi' },
            { han: 'å­¦æ ¡', pinyin: 'xuexiao' },
            { han: 'å­¦ä¹ ', pinyin: 'xuexi' },
            { han: 'ä¸­å›½', pinyin: 'zhongguo' },
            { han: 'ä½ å¥½', pinyin: 'nihao' },
            { han: 'è°¢è°¢', pinyin: 'xiexie' },
            { han: 'å†è§', pinyin: 'zaijian' },
            { han: 'æ°´', pinyin: 'shui' },
            { han: 'ç«', pinyin: 'huo' },
            { han: 'å¤©', pinyin: 'tian' },
            { han: 'åœ°', pinyin: 'di' },
            { han: 'äºº', pinyin: 'ren' },
            { han: 'å¤§', pinyin: 'da' },
            { han: 'å°', pinyin: 'xiao' },
            { han: 'ä¸Š', pinyin: 'shang' },
            { han: 'ä¸‹', pinyin: 'xia' },
            { han: 'å±±', pinyin: 'shan' },
            { han: 'æ—¥', pinyin: 'ri' },
            { han: 'æœˆ', pinyin: 'yue' },
            { han: 'æ˜Ÿ', pinyin: 'xing' }
        ];

        const charOptions = [
            { correct: 'é©¬', options: ['å¦ˆ', 'é©¬', 'å—'] },
            { correct: 'çŒ«', options: ['çŒ«', 'è‹—', 'æ'] },
            { correct: 'ç‹—', options: ['ç‹—', 'å¤Ÿ', 'é’©'] },
            { correct: 'é±¼', options: ['é±¼', 'é›¨', 'äº'] },
            { correct: 'é¸Ÿ', options: ['é¸Ÿ', 'è¢…', 'å°¿'] },
            { correct: 'çˆ¸', options: ['çˆ¸', 'å…«', 'å·´'] },
            { correct: 'å¦ˆ', options: ['å¦ˆ', 'å—', 'é©¬'] },
            { correct: 'å¥½', options: ['å¥½', 'å·', 'æµ©'] }
        ];

        // Keyboard Layout
        const keyboardRows = [
            '1234567890'.split(''),
            'QWERTYUIOP'.split(''),
            'ASDFGHJKL'.split(''),
            'ZXCVBNM'.split('')
        ];

        // Mobile keyboard layout
        const mobileKeyboardRows = [
            'qwertyuiop'.split(''),
            'asdfghjkl'.split(''),
            'zxcvbnm'.split('')
        ];

        // Audio Context
        let audioCtx = null;
        let speechSynth = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (!speechSynth) {
                speechSynth = window.speechSynthesis;
            }
        }

        function speak(text, lang = 'zh-CN') {
            if (!speechSynth) return;
            speechSynth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.8;
            utterance.pitch = 1.2;
            speechSynth.speak(utterance);
        }

        function speakLetter(letter) {
            speak(letter.toUpperCase(), 'en-US');
        }

        function speakChinese(text) {
            speak(text, 'zh-CN');
        }

        // Detect mobile
        function detectMobile() {
            state.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || window.innerWidth < 769;
        }

        // Initialize Desktop Keyboard
        function initKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';
            
            keyboardRows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                
                row.forEach(key => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    keyDiv.textContent = key;
                    keyDiv.dataset.keyUpper = key.toUpperCase();
                    keyDiv.dataset.keyLower = key.toLowerCase();
                    rowDiv.appendChild(keyDiv);
                });
                
                keyboard.appendChild(rowDiv);
            });
        }

        // Initialize Mobile Keyboard
        function initMobileKeyboard() {
            const keyboard = document.getElementById('mobileKeyboard');
            keyboard.innerHTML = '';
            
            mobileKeyboardRows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'mobile-keyboard-row';
                
                row.forEach(key => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'mobile-key';
                    keyDiv.textContent = key;
                    keyDiv.dataset.key = key;
                    keyDiv.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleKeyInput(key);
                    }, { passive: false });
                    rowDiv.appendChild(keyDiv);
                });
                
                keyboard.appendChild(rowDiv);
            });
        }

        // Show/hide mobile keyboard
        function updateKeyboardVisibility() {
            const mobileKeyboard = document.getElementById('mobileKeyboard');
            if (state.isMobile && state.isPlaying) {
                mobileKeyboard.classList.add('active');
            } else {
                mobileKeyboard.classList.remove('active');
            }
        }

        // Highlight Key
        function highlightKey(char) {
            // Desktop keyboard
            const keys = document.querySelectorAll('.key');
            const upperChar = char.toUpperCase();
            const lowerChar = char.toLowerCase();
            
            keys.forEach(key => {
                if (key.dataset.keyUpper === upperChar || key.dataset.keyLower === lowerChar) {
                    key.classList.add('highlight');
                }
            });

            // Mobile keyboard
            const mobileKeys = document.querySelectorAll('.mobile-key');
            mobileKeys.forEach(key => {
                if (key.dataset.key === lowerChar) {
                    key.classList.add('highlight');
                }
            });
        }

        function clearHighlight() {
            document.querySelectorAll('.key, .mobile-key').forEach(key => {
                key.classList.remove('highlight');
            });
        }

        function pressKey(char) {
            const upperChar = char.toUpperCase();
            const lowerChar = char.toLowerCase();
            
            // Desktop
            document.querySelectorAll('.key').forEach(key => {
                if (key.dataset.keyUpper === upperChar || key.dataset.keyLower === lowerChar) {
                    key.classList.add('pressed');
                    setTimeout(() => key.classList.remove('pressed'), 150);
                }
            });

            // Mobile
            document.querySelectorAll('.mobile-key').forEach(key => {
                if (key.dataset.key === lowerChar) {
                    key.classList.add('highlight');
                    setTimeout(() => key.classList.remove('highlight'), 150);
                }
            });
        }

        // Handle key input (both physical and mobile keyboard)
        function handleKeyInput(key) {
            if (!state.isPlaying || state.stage === 3) return;
            
            const k = key.toLowerCase();
            pressKey(key);
            
            if (state.stage === 1) {
                // Letter stage
                if (k === state.currentTarget.toLowerCase()) {
                    playSound('correct');
                    if (state.combo > 0) playSound('combo');
                    state.stars++;
                    state.combo++;
                    updateStats();
                    showStarPopup();
                    nextQuestion();
                } else {
                    playSound('error');
                    state.combo = 0;
                    updateStats();
                }
            } else if (state.stage === 2) {
                // Pinyin stage
                const target = state.currentTarget.toLowerCase();
                const expectedKey = target[state.currentInput.length];
                
                if (k === expectedKey) {
                    state.currentInput += k;
                    pressKey(k);
                    
                    const display = document.getElementById('pinyinDisplay');
                    if (display) {
                        display.innerHTML = state.currentTarget.substring(0, state.currentInput.length) + 
                            '<span style="color: #4ECDC4">' + 
                            state.currentTarget.substring(state.currentInput.length) + 
                            '</span>';
                    }
                    
                    clearHighlight();
                    if (state.currentInput.length < target.length) {
                        setTimeout(() => highlightKey(target[state.currentInput.length]), 100);
                    }
                    
                    if (state.currentInput.toLowerCase() === target) {
                        playSound('correct');
                        if (state.combo > 0) playSound('combo');
                        state.stars++;
                        state.combo++;
                        updateStats();
                        showStarPopup();
                        setTimeout(nextQuestion, 500);
                    }
                } else {
                    playSound('error');
                    state.combo = 0;
                    updateStats();
                    state.currentInput = '';
                    const display = document.getElementById('pinyinDisplay');
                    if (display) {
                        display.textContent = state.currentTarget;
                    }
                    setTimeout(() => highlightKey(target[0]), 100);
                }
            }
        }

        // Start Game
        function startGame() {
            initAudio();
            detectMobile();
            state.isPlaying = true;
            state.stars = 0;
            state.combo = 0;
            state.currentInput = '';
            updateStats();
            updateKeyboardVisibility();
            speakChinese('æ¸¸æˆå¼€å§‹ï¼');
            nextQuestion();
        }

        // Next Question
        function nextQuestion() {
            clearHighlight();
            stopTimer();
            state.currentInput = '';
            updateKeyboardVisibility();
            
            if (state.stage === 1) {
                state.currentTarget = letters[Math.floor(Math.random() * letters.length)];
                showLetterQuestion();
            } else if (state.stage === 2) {
                const data = pinyinData[Math.floor(Math.random() * pinyinData.length)];
                state.currentTarget = data.pinyin;
                state.hanzi = data.han;
                showPinyinQuestion();
            } else if (state.stage === 3) {
                const data = charOptions[Math.floor(Math.random() * charOptions.length)];
                state.currentTarget = data.correct;
                state.options = data.options;
                showCharQuestion();
            }
            
            startTimer();
        }

        function showLetterQuestion() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="current-char">${state.currentTarget}</div>
                <div class="hint">è¯·åœ¨é”®ç›˜ä¸Šæ‰¾å‡ºè¿™ä¸ªå­—æ¯å¹¶æŒ‰ä¸‹</div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            `;
            setTimeout(() => highlightKey(state.currentTarget), 50);
            setTimeout(() => speakLetter(state.currentTarget), 300);
        }

        function showPinyinQuestion() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="pinyin-label">${state.hanzi}</div>
                <div class="current-char" id="pinyinDisplay">${state.currentTarget}</div>
                <div class="hint">è¯·è¾“å…¥è¿™ä¸ªå­—çš„æ‹¼éŸ³</div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            `;
            if (state.currentTarget.length > 0) {
                setTimeout(() => highlightKey(state.currentTarget[0]), 50);
            }
            setTimeout(() => speakChinese(state.hanzi + 'ï¼Œ' + state.currentTarget), 300);
        }

        function showCharQuestion() {
            const gameArea = document.getElementById('gameArea');
            const optionsHtml = state.options.map((opt, i) => 
                `<button class="char-option" data-index="${i}" onclick="selectChar(${i})">${opt}</button>`
            ).join('');
            
            gameArea.innerHTML = `
                <div class="pinyin-label">è¯·é€‰æ‹©æ­£ç¡®çš„æ±‰å­—</div>
                <div class="current-char">${state.currentTarget}</div>
                <div class="char-options">${optionsHtml}</div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            `;
            setTimeout(() => speakChinese('è¯·é€‰æ‹©' + state.currentTarget + 'å­—'), 300);
        }

        function restartGame() {
            state.stars = 0;
            state.combo = 0;
            state.currentInput = '';
            updateStats();
            nextQuestion();
        }

        function selectChar(index) {
            const selected = state.options[index];
            const buttons = document.querySelectorAll('.char-option');
            
            if (selected === state.currentTarget) {
                buttons[index].classList.add('correct');
                playSound('correct');
                playSound('star');
                state.stars++;
                state.combo++;
                updateStats();
                showStarPopup();
                setTimeout(nextQuestion, 800);
            } else {
                buttons[index].classList.add('wrong');
                playSound('error');
                state.combo = 0;
                updateStats();
                setTimeout(nextQuestion, 800);
            }
        }

        function startTimer() {
            const timerContainer = document.getElementById('timerContainer');
            const timerBar = document.getElementById('timerBar');
            
            if (state.difficulty === 'easy') {
                timerContainer.style.display = 'none';
                return;
            }
            
            timerContainer.style.display = 'block';
            state.maxTime = state.difficulty === 'medium' ? 10 : 5;
            state.timeLeft = state.maxTime;
            
            timerBar.style.width = '100%';
            
            if (state.timer) clearInterval(state.timer);
            
            state.timer = setInterval(() => {
                state.timeLeft -= 0.1;
                const percentage = (state.timeLeft / state.maxTime) * 100;
                timerBar.style.width = Math.max(0, percentage) + '%';
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    playSound('error');
                    state.combo = 0;
                    updateStats();
                    nextQuestion();
                }
            }, 100);
        }

        function stopTimer() {
            if (state.timer) {
                clearInterval(state.timer);
                state.timer = null;
            }
        }

        function updateStats() {
            document.getElementById('stars').textContent = state.stars;
            document.getElementById('combo').textContent = state.combo;
        }

        function showStarPopup() {
            const star = document.createElement('div');
            star.className = 'star-popup';
            star.textContent = 'â­';
            star.style.left = '50%';
            star.style.top = '40%';
            document.body.appendChild(star);
            setTimeout(() => star.remove(), 1000);
        }

        function checkCapsLock(e) {
            const warning = document.getElementById('capsWarning');
            if (e.getModifierState && e.getModifierState('CapsLock')) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // Physical keyboard input
        document.addEventListener('keydown', (e) => {
            checkCapsLock(e);
            
            if (!state.isPlaying) return;
            if (state.stage === 3) return;
            
            const key = e.key.toLowerCase();
            if (!/^[a-z]$/.test(key)) return;
            
            handleKeyInput(key);
        });

        // Stage selector
        document.querySelectorAll('.stage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.stage-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.stage = parseInt(btn.dataset.stage);
                state.combo = 0;
                state.currentInput = '';
                updateStats();
                
                const gameArea = document.getElementById('gameArea');
                gameArea.innerHTML = `
                    <div class="start-screen">
                        <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ ğŸ®</button>
                    </div>
                `;
                clearHighlight();
                updateKeyboardVisibility();
            });
        });

        // Difficulty selector
        document.getElementById('difficulty').addEventListener('change', (e) => {
            state.difficulty = e.target.value;
        });

        // Initialize
        detectMobile();
        initKeyboard();
        initMobileKeyboard();
    </script>
</body>
</html>
