<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„¿ç«¥æ‰“å­—å­¦ä¹ æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            touch-action: manipulation;
        }

        body {
            font-family: 'Comic Sans MS', 'Microsoft YaHei', cursive, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #E0F7FA 50%, #98FB98 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
        }

        .header { text-align: center; margin-bottom: 15px; }
        
        .title {
            font-size: clamp(24px, 6vw, 36px);
            color: #FF6B6B;
            text-shadow: 2px 2px 0 #FFE66D;
            margin-bottom: 8px;
        }

        .stats { display: flex; gap: 20px; justify-content: center; }
        
        .stat {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: clamp(16px, 4vw, 20px);
        }

        .star { color: #FFD700; }
        .combo { color: #FF6B6B; }

        .stage-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stage-btn {
            padding: 10px 16px;
            font-size: clamp(14px, 3.5vw, 18px);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
        }

        .stage-btn:nth-child(1) { background: #4ECDC4; color: white; }
        .stage-btn:nth-child(2) { background: #45B7D1; color: white; }
        .stage-btn:nth-child(3) { background: #96CEB4; color: white; }
        .stage-btn.active { transform: scale(1.05); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }

        .difficulty { margin-bottom: 15px; }
        
        .difficulty select {
            padding: 8px 16px;
            font-size: clamp(14px, 3.5vw, 16px);
            border-radius: 15px;
            border: 2px solid #4ECDC4;
            font-family: inherit;
        }

        .game-area {
            background: white;
            border-radius: 25px;
            padding: clamp(20px, 5vw, 40px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
            width: 100%;
            max-width: 500px;
            min-height: 180px;
            margin-bottom: 20px;
        }

        .current-char {
            font-size: clamp(60px, 20vw, 120px);
            color: #333;
            margin: 15px 0;
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .pinyin-label { font-size: clamp(20px, 5vw, 28px); color: #666; margin-bottom: 10px; }
        .hint { font-size: clamp(14px, 3.5vw, 18px); color: #999; }

        /* Virtual Keyboard */
        .keyboard-container {
            width: 100%;
            max-width: 600px;
            background: #2C3E50;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .keyboard-row { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }

        .key {
            width: clamp(28px, 8vw, 50px);
            height: clamp(28px, 8vw, 50px);
            background: #34495E;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(12px, 3vw, 22px);
            color: white;
            cursor: pointer;
            user-select: none;
        }

        .key:active { transform: scale(0.95); }
        .key.highlight { background: #F39C12 !important; transform: scale(1.1); box-shadow: 0 0 15px #F39C12; }
        .key.pressed { background: #27AE60 !important; }

        /* Timer */
        .timer {
            width: 100%;
            max-width: 200px;
            height: 8px;
            background: #EEE;
            border-radius: 4px;
            margin: 0 auto 15px;
            overflow: hidden;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #45B7D1);
            width: 100%;
        }

        /* Star Animation */
        .star-popup {
            position: fixed;
            font-size: clamp(40px, 10vw, 60px);
            animation: starFly 1s forwards;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes starFly {
            0% { opacity: 1; transform: scale(0) translateY(0); }
            50% { opacity: 1; transform: scale(1.2) translateY(-50px); }
            100% { opacity: 0; transform: scale(1) translateY(-100px); }
        }

        /* Character Options */
        .char-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .char-option {
            width: clamp(50px, 15vw, 80px);
            height: clamp(50px, 15vw, 80px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(24px, 6vw, 40px);
            color: white;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .char-option:active { transform: scale(0.95); }
        .char-option.correct { background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); }
        .char-option.wrong { background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%); }

        /* Start Screen */
        .start-screen { text-align: center; }

        .start-btn {
            font-size: clamp(20px, 5vw, 28px);
            padding: 15px 40px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
        }

        .restart-btn {
            font-size: clamp(14px, 3.5vw, 18px);
            padding: 8px 20px;
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 15px;
            font-family: inherit;
        }

        .caps-warning {
            background: #FFE66D;
            color: #333;
            padding: 8px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: clamp(12px, 3vw, 16px);
            display: none;
        }

        @media (max-width: 768px) {
            .keyboard-container { display: flex; flex-direction: column; gap: 5px; }
            .keyboard-row { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ¯ å„¿ç«¥æ‰“å­—å­¦ä¹ æ¸¸æˆ</h1>
        <div class="stats">
            <div class="stat">â­ <span id="stars">0</span></div>
            <div class="stat">ğŸ”¥ Combo: <span id="combo">0</span></div>
        </div>
    </div>

    <div class="caps-warning" id="capsWarning">âš ï¸ è¯·å…³é—­ Caps Lock</div>

    <div class="stage-selector">
        <button class="stage-btn active" data-stage="1">ğŸ”¤ å­—æ¯</button>
        <button class="stage-btn" data-stage="2">ğŸ“ æ‹¼éŸ³</button>
        <button class="stage-btn" data-stage="3">ğŸˆ¶ é€‰å­—</button>
    </div>

    <div class="difficulty">
        <select id="difficulty">
            <option value="easy">ğŸŒŸ ç®€å•</option>
            <option value="medium">âš¡ ä¸­ç­‰</option>
            <option value="hard">ğŸ”¥ å›°éš¾</option>
        </select>
    </div>

    <div class="game-area" id="gameArea">
        <div class="start-screen">
            <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ ğŸ®</button>
        </div>
    </div>

    <div class="keyboard-container" id="keyboardContainer"></div>

    <div class="timer" id="timerContainer" style="display: none;">
        <div class="timer-bar" id="timerBar"></div>
    </div>

    <script>
        // Game State
        let state = {
            stage: 1,
            difficulty: 'easy',
            stars: 0,
            combo: 0,
            currentTarget: '',
            currentInput: '',
            isPlaying: false,
            timer: null,
            timeLeft: 10,
            maxTime: 10
        };

        // Data
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
        
        const pinyinData = [
            { han: 'é©¬', pinyin: 'ma' }, { han: 'çŒ«', pinyin: 'mao' }, { han: 'ç‹—', pinyin: 'gou' },
            { han: 'é±¼', pinyin: 'yu' }, { han: 'é¸Ÿ', pinyin: 'niao' }, { han: 'å…”', pinyin: 'tu' },
            { han: 'çŒª', pinyin: 'zhu' }, { han: 'ç¾Š', pinyin: 'yang' }, { han: 'ç‰›', pinyin: 'niu' },
            { han: 'è‹¹æœ', pinyin: 'pingguo' }, { han: 'çˆ¸çˆ¸', pinyin: 'baba' }, { han: 'å¦ˆå¦ˆ', pinyin: 'mama' },
            { han: 'çˆ·çˆ·', pinyin: 'yeye' }, { han: 'å¥¶å¥¶', pinyin: 'naiai' }, { han: 'å“¥å“¥', pinyin: 'gege' },
            { han: 'å¼Ÿå¼Ÿ', pinyin: 'didi' }, { han: 'å§å§', pinyin: 'jiejie' }, { han: 'å¦¹å¦¹', pinyin: 'meimei' },
            { han: 'æœ‹å‹', pinyin: 'pengyou' }, { han: 'è€å¸ˆ', pinyin: 'laoshi' }, { han: 'å­¦æ ¡', pinyin: 'xuexiao' },
            { han: 'å­¦ä¹ ', pinyin: 'xuexi' }, { han: 'ä¸­å›½', pinyin: 'zhongguo' }, { han: 'ä½ å¥½', pinyin: 'nihao' },
            { han: 'è°¢è°¢', pinyin: 'xiexie' }, { han: 'å†è§', pinyin: 'zaijian' }, { han: 'æ°´', pinyin: 'shui' },
            { han: 'ç«', pinyin: 'huo' }, { han: 'å¤©', pinyin: 'tian' }, { han: 'åœ°', pinyin: 'di' },
            { han: 'äºº', pinyin: 'ren' }, { han: 'å¤§', pinyin: 'da' }, { han: 'å°', pinyin: 'xiao' },
            { han: 'ä¸Š', pinyin: 'shang' }, { han: 'ä¸‹', pinyin: 'xia' }, { han: 'å±±', pinyin: 'shan' },
            { han: 'æ—¥', pinyin: 'ri' }, { han: 'æœˆ', pinyin: 'yue' }, { han: 'æ˜Ÿ', pinyin: 'xing' }
        ];

        const charOptions = [
            { correct: 'é©¬', options: ['å¦ˆ', 'é©¬', 'å—'] }, { correct: 'çŒ«', options: ['çŒ«', 'è‹—', 'æ'] },
            { correct: 'ç‹—', options: ['ç‹—', 'å¤Ÿ', 'é’©'] }, { correct: 'é±¼', options: ['é±¼', 'é›¨', 'äº'] },
            { correct: 'é¸Ÿ', options: ['é¸Ÿ', 'è¢…', 'å°¿'] }, { correct: 'çˆ¸', options: ['çˆ¸', 'å…«', 'å·´'] },
            { correct: 'å¦ˆ', options: ['å¦ˆ', 'å—', 'é©¬'] }, { correct: 'å¥½', options: ['å¥½', 'å·', 'æµ©'] }
        ];

        // Keyboard Layout
        const keyboardRows = [
            '1234567890'.split(''),
            'QWERTYUIOP'.split(''),
            'ASDFGHJKL'.split(''),
            'ZXCVBNM'.split('')
        ];

        // Audio & Speech
        let audioCtx = null;
        let speechSynth = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (!speechSynth) speechSynth = window.speechSynthesis;
        }

        function speak(text, lang = 'zh-CN') {
            if (!speechSynth) return;
            speechSynth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.8;
            utterance.pitch = 1.2;
            speechSynth.speak(utterance);
        }

        function speakLetter(letter) {
            speak('è¯·æŒ‰' + letter.toUpperCase() + 'é”®', 'zh-CN');
        }

        function speakChinese(text) {
            speak(text, 'zh-CN');
        }

        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            switch(type) {
                case 'correct':
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'error':
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
                case 'star':
                    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.4);
                    break;
            }
        }

        // Initialize Keyboard
        function initKeyboard() {
            const container = document.getElementById('keyboardContainer');
            container.innerHTML = '';
            
            keyboardRows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                
                row.forEach(key => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    keyDiv.textContent = key;
                    keyDiv.dataset.keyUpper = key.toUpperCase();
                    keyDiv.dataset.keyLower = key.toLowerCase();
                    keyDiv.addEventListener('click', () => handleKeyInput(key));
                    rowDiv.appendChild(keyDiv);
                });
                
                container.appendChild(rowDiv);
            });
        }

        function highlightKey(char) {
            const keys = document.querySelectorAll('.key');
            const upper = char.toUpperCase();
            const lower = char.toLowerCase();
            
            keys.forEach(key => {
                if (key.dataset.keyUpper === upper || key.dataset.keyLower === lower) {
                    key.classList.add('highlight');
                }
            });
        }

        function clearHighlight() {
            document.querySelectorAll('.key').forEach(key => key.classList.remove('highlight'));
        }

        function pressKeyVisual(char) {
            const keys = document.querySelectorAll('.key');
            const upper = char.toUpperCase();
            const lower = char.toLowerCase();
            
            keys.forEach(key => {
                if (key.dataset.keyUpper === upper || key.dataset.keyLower === lower) {
                    key.classList.add('pressed');
                    setTimeout(() => key.classList.remove('pressed'), 150);
                }
            });
        }

        // Handle Key Input - THE CORE LOGIC
        function handleKeyInput(key) {
            console.log('handleKeyInput called:', key, 'stage:', state.stage, 'playing:', state.isPlaying);
            
            if (!state.isPlaying) {
                console.log('Not playing, ignoring');
                return;
            }
            if (state.stage === 3) {
                console.log('Stage 3 uses mouse, ignoring');
                return; // Stage 3 uses mouse clicks
            }
            
            const k = key.toLowerCase();
            console.log('Processing key:', k, 'target:', state.currentTarget);
            
            // Visual feedback
            pressKeyVisual(k);
            
            if (state.stage === 1) {
                // Letter stage - direct match
                if (k === state.currentTarget.toLowerCase()) {
                    console.log('Correct!');
                    playSound('correct');
                    playSound('star');
                    speakChinese('ç­”å¯¹äº†ï¼');
                    state.stars++;
                    state.combo++;
                    updateStats();
                    showStarPopup();
                    // ç­‰å¾…è¯­éŸ³æ’­æ”¾å®Œå†è·³ä¸‹ä¸€ä¸ª (1.5ç§’)
                    setTimeout(() => nextQuestion(), 1500);
                } else {
                    console.log('Wrong!');
                    playSound('error');
                    speakChinese('ç­”é”™äº†ï¼Œå†è¯•ä¸€æ¬¡');
                    state.combo = 0;
                    updateStats();
                }
            } else if (state.stage === 2) {
                // Pinyin stage
                const target = state.currentTarget.toLowerCase();
                const expectedKey = target[state.currentInput.length];
                
                console.log('Pinyin - expected:', expectedKey, 'got:', k, 'currentInput:', state.currentInput);
                
                if (k === expectedKey) {
                    // Correct key
                    state.currentInput += k;
                    
                    // Update display to show progress
                    const display = document.getElementById('pinyinDisplay');
                    if (display) {
                        display.innerHTML = state.currentTarget.substring(0, state.currentInput.length) + 
                            '<span style="color: #4ECDC4">' + 
                            state.currentTarget.substring(state.currentInput.length) + 
                            '</span>';
                    }
                    
                    // Highlight next character
                    clearHighlight();
                    if (state.currentInput.length < target.length) {
                        setTimeout(() => highlightKey(target[state.currentInput.length]), 100);
                    }
                    
                    // Check if complete
                    if (state.currentInput.toLowerCase() === target) {
                        console.log('Pinyin complete!');
                        playSound('correct');
                        playSound('star');
                        speakChinese('ç­”å¯¹äº†ï¼');
                        state.stars++;
                        state.combo++;
                        updateStats();
                        showStarPopup();
                        // ç­‰å¾…è¯­éŸ³æ’­æ”¾å®Œå†è·³ä¸‹ä¸€ä¸ª
                        setTimeout(() => nextQuestion(), 1500);
                    }
                } else {
                    // Wrong key
                    console.log('Pinyin wrong!');
                    playSound('error');
                    speakChinese('ç­”é”™äº†ï¼Œå†è¯•ä¸€æ¬¡');
                    state.combo = 0;
                    updateStats();
                    // Reset input
                    state.currentInput = '';
                    const display = document.getElementById('pinyinDisplay');
                    if (display) display.textContent = state.currentTarget;
                    setTimeout(() => highlightKey(target[0]), 100);
                }
            }
        }

        // Start Game
        function startGame() {
            initAudio();
            state.isPlaying = true;
            state.stars = 0;
            state.combo = 0;
            state.currentInput = '';
            updateStats();
            speakChinese('æ¸¸æˆå¼€å§‹ï¼');
            nextQuestion();
        }

        // Next Question
        function nextQuestion() {
            console.log('nextQuestion called, stage:', state.stage);
            clearHighlight();
            stopTimer();
            state.currentInput = '';
            
            if (state.stage === 1) {
                state.currentTarget = letters[Math.floor(Math.random() * letters.length)];
                showLetterQuestion();
            } else if (state.stage === 2) {
                const data = pinyinData[Math.floor(Math.random() * pinyinData.length)];
                state.currentTarget = data.pinyin;
                state.hanzi = data.han;
                showPinyinQuestion();
            } else if (state.stage === 3) {
                const data = charOptions[Math.floor(Math.random() * charOptions.length)];
                state.currentTarget = data.correct;
                state.options = data.options;
                showCharQuestion();
            }
            
            startTimer();
        }

        function showLetterQuestion() {
            console.log('showLetterQuestion:', state.currentTarget);
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="current-char">${state.currentTarget}</div>
                <div class="hint">è¯·åœ¨é”®ç›˜ä¸Šæ‰¾å‡ºè¿™ä¸ªå­—æ¯å¹¶æŒ‰ä¸‹</div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            `;
            setTimeout(() => highlightKey(state.currentTarget), 50);
            setTimeout(() => speakLetter(state.currentTarget), 300);
        }

        function showPinyinQuestion() {
            console.log('showPinyinQuestion:', state.currentTarget, state.hanzi);
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="pinyin-label">${state.hanzi}</div>
                <div class="current-char" id="pinyinDisplay">${state.currentTarget}</div>
                <div class="hint">è¯·è¾“å…¥è¿™ä¸ªå­—çš„æ‹¼éŸ³</div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            `;
            if (state.currentTarget.length > 0) {
                setTimeout(() => highlightKey(state.currentTarget[0]), 50);
            }
            setTimeout(() => speakChinese(state.hanzi + 'ï¼Œ' + state.currentTarget), 300);
        }

        function showCharQuestion() {
            const gameArea = document.getElementById('gameArea');
            const optionsHtml = state.options.map((opt, i) => 
                `<button class="char-option" onclick="selectChar(${i})">${opt}</button>`
            ).join('');
            
            gameArea.innerHTML = `
                <div class="pinyin-label">è¯·é€‰æ‹©æ­£ç¡®çš„æ±‰å­—</div>
                <div class="current-char">${state.currentTarget}</div>
                <div class="char-options">${optionsHtml}</div>
                <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            `;
            setTimeout(() => speakChinese('è¯·é€‰æ‹©' + state.currentTarget + 'å­—'), 300);
        }

        function restartGame() {
            state.stars = 0;
            state.combo = 0;
            state.currentInput = '';
            updateStats();
            nextQuestion();
        }

        function selectChar(index) {
            const selected = state.options[index];
            const buttons = document.querySelectorAll('.char-option');
            
            if (selected === state.currentTarget) {
                buttons[index].classList.add('correct');
                playSound('correct');
                playSound('star');
                speakChinese('ç­”å¯¹äº†ï¼');
                state.stars++;
                state.combo++;
                updateStats();
                showStarPopup();
                // ç­‰å¾…è¯­éŸ³æ’­æ”¾å®Œå†è·³ä¸‹ä¸€ä¸ª
                setTimeout(() => nextQuestion(), 1500);
            } else {
                buttons[index].classList.add('wrong');
                playSound('error');
                speakChinese('ç­”é”™äº†ï¼Œå†è¯•ä¸€æ¬¡');
                state.combo = 0;
                updateStats();
                setTimeout(nextQuestion, 800);
            }
        }

        function startTimer() {
            const timerContainer = document.getElementById('timerContainer');
            const timerBar = document.getElementById('timerBar');
            
            if (state.difficulty === 'easy') {
                timerContainer.style.display = 'none';
                return;
            }
            
            timerContainer.style.display = 'block';
            state.maxTime = state.difficulty === 'medium' ? 10 : 5;
            state.timeLeft = state.maxTime;
            timerBar.style.width = '100%';
            
            if (state.timer) clearInterval(state.timer);
            
            state.timer = setInterval(() => {
                state.timeLeft -= 0.1;
                const percentage = (state.timeLeft / state.maxTime) * 100;
                timerBar.style.width = Math.max(0, percentage) + '%';
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    playSound('error');
                    speakChinese('æ—¶é—´åˆ°äº†ï¼');
                    state.combo = 0;
                    updateStats();
                    nextQuestion();
                }
            }, 100);
        }

        function stopTimer() {
            if (state.timer) {
                clearInterval(state.timer);
                state.timer = null;
            }
        }

        function updateStats() {
            document.getElementById('stars').textContent = state.stars;
            document.getElementById('combo').textContent = state.combo;
        }

        function showStarPopup() {
            const star = document.createElement('div');
            star.className = 'star-popup';
            star.textContent = 'â­';
            star.style.left = '50%';
            star.style.top = '40%';
            document.body.appendChild(star);
            setTimeout(() => star.remove(), 1000);
        }

        function checkCapsLock(e) {
            const warning = document.getElementById('capsWarning');
            if (e.getModifierState && e.getModifierState('CapsLock')) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // Physical keyboard
        document.addEventListener('keydown', (e) => {
            checkCapsLock(e);
            if (!state.isPlaying) return;
            if (state.stage === 3) return;
            
            const key = e.key.toLowerCase();
            if (!/^[a-z]$/.test(key)) return;
            
            handleKeyInput(key);
        });

        // Stage selector
        document.querySelectorAll('.stage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.stage-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.stage = parseInt(btn.dataset.stage);
                state.combo = 0;
                state.currentInput = '';
                updateStats();
                
                document.getElementById('gameArea').innerHTML = `
                    <div class="start-screen">
                        <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ ğŸ®</button>
                    </div>
                `;
                clearHighlight();
            });
        });

        // Difficulty selector
        document.getElementById('difficulty').addEventListener('change', (e) => {
            state.difficulty = e.target.value;
        });

        // Initialize
        initKeyboard();
    </script>
</body>
</html>
